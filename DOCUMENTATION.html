<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocumentaciÃ³n TÃ©cnica - Sistema de AuditorÃ­a Rokys</title>
    <style>
        @page {
            margin: 2cm;
            size: A4;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 210mm;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header-logo {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }
        
        .header-logo img {
            max-width: 250px;
            height: auto;
            margin-bottom: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
        }
        
        .header-title {
            color: white;
            font-size: 32px;
            font-weight: 700;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header-subtitle {
            color: #f0f0f0;
            font-size: 18px;
            margin: 5px 0;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-top: 40px;
            page-break-before: auto;
            page-break-after: avoid;
        }
        
        h2 {
            color: #34495e;
            border-bottom: 2px solid #95a5a6;
            padding-bottom: 8px;
            margin-top: 30px;
            page-break-after: avoid;
        }
        
        h3 {
            color: #555;
            margin-top: 20px;
            background-color: #ecf0f1;
            padding: 10px;
            border-left: 4px solid #3498db;
            page-break-after: avoid;
        }
        
        h4 {
            color: #666;
            margin-top: 15px;
            font-weight: 600;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 11px;
            page-break-inside: avoid;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        table thead tr {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: left;
        }
        
        table th {
            padding: 12px;
            font-weight: 600;
        }
        
        table tbody tr {
            border-bottom: 1px solid #ddd;
        }
        
        table tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        table tbody tr:hover {
            background-color: #e9ecef;
        }
        
        table td {
            padding: 10px;
        }
        
        code {
            background-color: #f4f4f4;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 90%;
            color: #e74c3c;
        }
        
        pre {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        
        pre code {
            background-color: transparent;
            color: #f8f8f2;
            padding: 0;
        }
        
        ul, ol {
            margin: 10px 0;
            padding-left: 30px;
        }
        
        li {
            margin: 5px 0;
        }
        
        hr {
            border: none;
            border-top: 2px solid #ecf0f1;
            margin: 30px 0;
        }
        
        .toc {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .toc h2 {
            margin-top: 0;
        }
        
        .emoji {
            font-size: 1.2em;
        }
        
        blockquote {
            border-left: 4px solid #3498db;
            padding-left: 15px;
            margin: 20px 0;
            color: #555;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
        }
        
        .diagram {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre;
            overflow-x: auto;
            border: 1px solid #ddd;
        }
        
        @media print {
            body {
                background-color: white;
            }
            
            h1, h2, h3, h4 {
                page-break-after: avoid;
            }
            
            table, pre, .diagram {
                page-break-inside: avoid;
            }
            
            .header-logo {
                page-break-after: avoid;
            }
        }
    </style>
</head>
<body>
<div class="header-logo">
    <img src="https://www.ruway.tech/static/media/logo.0daae2dc.png" alt="Ruwaytech Logo">
    <div class="header-title">DocumentaciÃ³n TÃ©cnica</div>
    <div class="header-subtitle">Sistema de AuditorÃ­a Rokys</div>
</div>
<h1>DocumentaciÃ³n TÃ©cnica - Sistema de AuditorÃ­a Rokys</h1>
<br>
<h2>ğŸ“‘ Tabla de Contenidos</h2>
<br>
<li><a href="#visiÃ³n-general-del-proyecto">VisiÃ³n General del Proyecto</a></li>
<li><a href="#arquitectura-del-sistema">Arquitectura del Sistema</a></li>
<li><a href="#tecnologÃ­as-y-frameworks">TecnologÃ­as y Frameworks</a></li>
<li><a href="#estructura-del-proyecto">Estructura del Proyecto</a></li>
<li><a href="#modelo-de-datos">Modelo de Datos</a></li>
<li><a href="#componentes-principales">Componentes Principales</a></li>
<li><a href="#api-y-endpoints">API y Endpoints</a></li>
<li><a href="#seguridad-y-autenticaciÃ³n">Seguridad y AutenticaciÃ³n</a></li>
<li><a href="#integraciÃ³n-con-microservicios">IntegraciÃ³n con Microservicios</a></li>
<li><a href="#configuraciÃ³n-y-despliegue">ConfiguraciÃ³n y Despliegue</a></li>
<li><a href="#guÃ­as-de-desarrollo">GuÃ­as de Desarrollo</a></li>
<br>
<hr>
<br>
<h2>VisiÃ³n General del Proyecto</h2>
<br>
<h3>ğŸ¯ PropÃ³sito</h3>
<br>
<p>El <strong>Sistema de AuditorÃ­a Rokys</strong> es una aplicaciÃ³n empresarial diseÃ±ada para gestionar y ejecutar auditorÃ­as periÃ³dicas en tiendas de la organizaciÃ³n. El sistema permite:</p>
<br>
<ul>
<li>âœ… <strong>Configurar criterios de auditorÃ­a</strong> personalizados por empresa</li>
<li>âœ… <strong>Ejecutar auditorÃ­as periÃ³dicas</strong> con plantillas configurables</li>
<li>âœ… <strong>Evaluar resultados</strong> automÃ¡ticamente segÃºn criterios de puntuaciÃ³n</li>
<li>âœ… <strong>Generar reportes</strong> en PDF y Excel</li>
<li>âœ… <strong>Gestionar flujo de aprobaciones</strong> mediante bandeja de entrada</li>
<li>âœ… <strong>Notificar eventos</strong> por email</li>
<li>âœ… <strong>Sincronizar datos</strong> con otros microservicios (Security, Memos)</li>
</ul>
<br>
<h3>ğŸ¢ Alcance</h3>
<br>
<p>El sistema cubre el ciclo completo de auditorÃ­as:</p>
<li><strong>ConfiguraciÃ³n</strong>: Empresas, tiendas, escalas, grupos, criterios</li>
<li><strong>EjecuciÃ³n</strong>: CreaciÃ³n de auditorÃ­as, captura de datos, evidencias</li>
<li><strong>EvaluaciÃ³n</strong>: CÃ¡lculo automÃ¡tico de puntuaciones y escalas</li>
<li><strong>AprobaciÃ³n</strong>: Flujo de trabajo con mÃºltiples roles</li>
<li><strong>ReporterÃ­a</strong>: GeneraciÃ³n de documentos PDF/Excel</li>
<li><strong>Notificaciones</strong>: Alertas por email en puntos clave del proceso</li>
<br>
<hr>
<br>
<h2>Arquitectura del Sistema</h2>
<br>
<h3>ğŸ—ï¸ PatrÃ³n de Arquitectura: Clean Architecture / DDD</h3>
<br>
<p>El proyecto sigue los principios de <strong>Clean Architecture</strong> con separaciÃ³n clara de responsabilidades:</p>
<br>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Rokys.Audit.WebAPI                       â”‚
â”‚  (Capa de PresentaciÃ³n - Controllers, Middleware, Filters) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Rokys.Audit.Services                       â”‚
â”‚      (Capa de AplicaciÃ³n - Business Logic, Validators)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Rokys.Audit.Infrastructure                     â”‚
â”‚    (Capa de Infraestructura - Repositories, Persistence)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Rokys.Audit.Model                         â”‚
â”‚              (Capa de Dominio - Entities, DTOs)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
<br>
<h3>ğŸ“¦ Capas del Sistema</h3>
<br>
<h4>1. **Capa de PresentaciÃ³n** (WebAPI)</h4>
<ul>
<li><strong>Responsabilidad</strong>: Exponer endpoints REST, manejar peticiones HTTP</li>
<li><strong>Componentes</strong>: Controllers, Filters, Middleware, Startup</li>
<li><strong>TecnologÃ­as</strong>: ASP.NET Core 9.0, Swagger/OpenAPI</li>
</ul>
<br>
<h4>2. **Capa de AplicaciÃ³n** (Services)</h4>
<ul>
<li><strong>Responsabilidad</strong>: LÃ³gica de negocio, orquestaciÃ³n de casos de uso</li>
<li><strong>Componentes</strong>: Services, Validators, DTOs</li>
<li><strong>TecnologÃ­as</strong>: FluentValidation, AutoMapper</li>
</ul>
<br>
<h4>3. **Capa de Infraestructura** (Infrastructure/Persistence)</h4>
<ul>
<li><strong>Responsabilidad</strong>: Acceso a datos, integraciÃ³n con servicios externos</li>
<li><strong>Componentes</strong>: Repositories (EF Core, Dapper), Email Service</li>
<li><strong>TecnologÃ­as</strong>: Entity Framework Core 7, Dapper, SMTP</li>
</ul>
<br>
<h4>4. **Capa de Dominio** (Model)</h4>
<ul>
<li><strong>Responsabilidad</strong>: Entidades de negocio, objetos de valor</li>
<li><strong>Componentes</strong>: Entities, Value Objects</li>
<li><strong>TecnologÃ­as</strong>: .NET 9.0</li>
</ul>
<br>
<h4>5. **Capa de IntegraciÃ³n** (Subscription.Hub)</h4>
<ul>
<li><strong>Responsabilidad</strong>: ComunicaciÃ³n con otros microservicios</li>
<li><strong>Componentes</strong>: Event Handlers, RabbitMQ Consumers</li>
<li><strong>TecnologÃ­as</strong>: RabbitMQ, Ruway.Events</li>
</ul>
<br>
<h3>ğŸ”„ Flujo de Datos</h3>
<br>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚â”€â”€â”€â”€â”€â–¶â”‚ Controller  â”‚â”€â”€â”€â”€â”€â–¶â”‚ Service  â”‚â”€â”€â”€â”€â”€â–¶â”‚Repositoryâ”‚
â”‚ (HTTP)  â”‚â—€â”€â”€â”€â”€â”€â”‚  (WebAPI)   â”‚â—€â”€â”€â”€â”€â”€â”‚(Business)â”‚â—€â”€â”€â”€â”€â”€â”‚  (Data)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                   â”‚
                        â”‚                   â–¼
                        â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚            â”‚ External     â”‚
                        â”‚            â”‚ Services     â”‚
                        â”‚            â”‚ (Email, etc) â”‚
                        â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚ RabbitMQ     â”‚
                 â”‚ Event Bus    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
<br>
<hr>
<br>
<h2>TecnologÃ­as y Frameworks</h2>
<br>
<h3>ğŸ› ï¸ Stack TecnolÃ³gico Principal</h3>
<br>
<table>
<thead><tr>
<th>CategorÃ­a</th>
<th>TecnologÃ­a</th>
<th>VersiÃ³n</th>
<th>Uso</th>
</tr>
</thead><tbody>
<tr>
<td><strong>Framework</strong></td>
<td>.NET</td>
<td>9.0</td>
<td>Runtime y SDK</td>
</tr>
<tr>
<td><strong>Web API</strong></td>
<td>ASP.NET Core</td>
<td>9.0</td>
<td>Framework web</td>
</tr>
<tr>
<td><strong>ORM</strong></td>
<td>Entity Framework Core</td>
<td>7.0.2</td>
<td>Acceso a datos principal</td>
</tr>
<tr>
<td><strong>Micro ORM</strong></td>
<td>Dapper</td>
<td>2.1.35</td>
<td>Consultas optimizadas</td>
</tr>
<tr>
<td><strong>Base de Datos</strong></td>
<td>SQL Server</td>
<td>2019+</td>
<td>Almacenamiento</td>
</tr>
<tr>
<td><strong>Mapeo</strong></td>
<td>AutoMapper</td>
<td>12.0.1</td>
<td>Mapeo DTO-Entity</td>
</tr>
<tr>
<td><strong>ValidaciÃ³n</strong></td>
<td>FluentValidation</td>
<td>11.4.0</td>
<td>Validaciones de negocio</td>
</tr>
<tr>
<td><strong>IoC</strong></td>
<td>Autofac</td>
<td>6.5.0</td>
<td>InyecciÃ³n de dependencias</td>
</tr>
<tr>
<td><strong>DocumentaciÃ³n API</strong></td>
<td>Swagger/Swashbuckle</td>
<td>6.6.2</td>
<td>DocumentaciÃ³n OpenAPI</td>
</tr>
<tr>
<td><strong>Logging</strong></td>
<td>Serilog</td>
<td>2.12.0</td>
<td>Registro de logs</td>
</tr>
<tr>
<td><strong>AutenticaciÃ³n</strong></td>
<td>JWT Bearer</td>
<td>6.0.13</td>
<td>AutenticaciÃ³n basada en tokens</td>
</tr>
<tr>
<td><strong>MensajerÃ­a</strong></td>
<td>RabbitMQ</td>
<td>-</td>
<td>Bus de eventos</td>
</tr>
<tr>
<td><strong>Reportes PDF</strong></td>
<td>QuestPDF</td>
<td>2025.7.4</td>
<td>GeneraciÃ³n de PDFs</td>
</tr>
<tr>
<td><strong>Reportes Excel</strong></td>
<td>ClosedXML</td>
<td>0.105.0</td>
<td>GeneraciÃ³n de Excel</td>
</tr>
<tr>
<td><strong>Templates</strong></td>
<td>Scriban</td>
<td>6.2.1</td>
<td>Motor de templates</td>
</tr>
</tbody></table>
<br>
<h3>ğŸ“š LibrerÃ­as Adicionales</h3>
<br>
<ul>
<li><strong>Newtonsoft.Json</strong>: SerializaciÃ³n JSON</li>
<li><strong>NeuroSpeech.RetroCoreFit</strong>: Cliente HTTP tipado</li>
<li><strong>Microsoft.Extensions.</strong>*: Extensiones de .NET</li>
</ul>
<br>
<hr>
<br>
<h2>Estructura del Proyecto</h2>
<br>
<h3>ğŸ“‚ OrganizaciÃ³n de Proyectos</h3>
<br>
<pre><code>rokys-audit-service/
â”œâ”€â”€ ğŸ“ Rokys.Audit.WebAPI/                    # API REST (Entry Point)
â”‚   â”œâ”€â”€ Controllers/                          # Endpoints REST
â”‚   â”œâ”€â”€ Middleware/                           # Middleware personalizado
â”‚   â”œâ”€â”€ Filters/                              # Filtros de acciÃ³n
â”‚   â”œâ”€â”€ Configuration/                        # Configuraciones
â”‚   â”œâ”€â”€ DependencyInjection/                  # Registro de servicios
â”‚   â”œâ”€â”€ Template/Mail/                        # Plantillas de email
â”‚   â”œâ”€â”€ Program.cs                            # Punto de entrada
â”‚   â””â”€â”€ Startup.cs                            # ConfiguraciÃ³n de servicios
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.Services/                  # LÃ³gica de Negocio
â”‚   â”œâ”€â”€ Services/                             # ImplementaciÃ³n de servicios
â”‚   â”‚   â”œâ”€â”€ *Service.cs                       # Servicios de dominio
â”‚   â”‚   â”œâ”€â”€ Emails/                           # Servicios de email
â”‚   â”‚   â”œâ”€â”€ Pdf/                              # GeneraciÃ³n de PDFs
â”‚   â”‚   â””â”€â”€ ReportUtils/                      # Utilidades de reportes
â”‚   â””â”€â”€ Validations/                          # Validadores FluentValidation
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.Services.Interfaces/       # Contratos de Servicios
â”‚   â””â”€â”€ I*Service.cs                          # Interfaces de servicios
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.Infrastructure/            # Infraestructura Base
â”‚   â”œâ”€â”€ IRepository.cs                        # Contrato genÃ©rico de repositorio
â”‚   â””â”€â”€ Common interfaces                     # Interfaces compartidas
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.Infrastructure.Persistence/ # Acceso a Datos Base
â”‚   â””â”€â”€ Base repository implementations
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.Infrastructure.Persistence.EF/ # Entity Framework
â”‚   â”œâ”€â”€ Storage/ApplicationDbContext.cs       # Contexto de EF
â”‚   â”œâ”€â”€ Repositories/                         # Repositorios EF
â”‚   â””â”€â”€ Configurations/                       # Configuraciones de entidades
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.Infrastructure.Persistence.Dp/ # Dapper
â”‚   â”œâ”€â”€ ContextDp.cs                          # Contexto de Dapper
â”‚   â””â”€â”€ Repositories/                         # Repositorios Dapper
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.Infrastructure.Mapping.AM/ # AutoMapper
â”‚   â””â”€â”€ AMMapper.cs                           # Perfiles de mapeo
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.Model/                     # Entidades de Dominio
â”‚   â””â”€â”€ Tables/                               # Entidades de tablas
â”‚       â”œâ”€â”€ AuditEntity.cs                    # Entidad base de auditorÃ­a
â”‚       â”œâ”€â”€ Enterprise.cs
â”‚       â”œâ”€â”€ Stores.cs
â”‚       â”œâ”€â”€ PeriodAudit.cs
â”‚       â””â”€â”€ ... (otras entidades)
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.DTOs/                      # Data Transfer Objects
â”‚   â”œâ”€â”€ Common/                               # DTOs comunes
â”‚   â”œâ”€â”€ Requests/                             # DTOs de peticiÃ³n
â”‚   â””â”€â”€ Responses/                            # DTOs de respuesta
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.External.Services/         # Servicios Externos
â”‚   â””â”€â”€ EmailService.cs                       # Servicio de correo
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.External.Services.Interfaces/ # Contratos Externos
â”‚   â””â”€â”€ IEmailService.cs
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.Subscription.Hub/          # Hub de Eventos
â”‚   â”œâ”€â”€ Services/                             # Manejadores de eventos
â”‚   â”œâ”€â”€ Configuration/                        # ConfiguraciÃ³n del hub
â”‚   â””â”€â”€ Extensions/                           # Extensiones DI
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.Globalization/             # InternacionalizaciÃ³n
â”‚   â””â”€â”€ ValidationMessage.resx                # Mensajes de validaciÃ³n
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.Common/                    # Utilidades Compartidas
â”‚   â”œâ”€â”€ Constant/                             # Constantes
â”‚   â”œâ”€â”€ Extensions/                           # MÃ©todos de extensiÃ³n
â”‚   â””â”€â”€ Helpers/                              # Clases auxiliares
â”‚
â”œâ”€â”€ ğŸ“ Rokys.Audit.DataBase/                  # Scripts de Base de Datos
â”‚   â”œâ”€â”€ Init/DataInitial.sql                  # Script de creaciÃ³n inicial
â”‚   â”œâ”€â”€ Inserts/                              # Scripts de datos iniciales
â”‚   â”œâ”€â”€ changelog.xml                         # Changelog de Liquibase
â”‚   â””â”€â”€ liquibase.properties                  # ConfiguraciÃ³n Liquibase
â”‚
â”œâ”€â”€ ğŸ“ publish/                                # Archivos publicados
â”œâ”€â”€ global.json                                # VersiÃ³n del SDK
â”œâ”€â”€ Rokys.Audit.Services.sln                   # SoluciÃ³n Visual Studio
â””â”€â”€ README.md                                  # DocumentaciÃ³n general</code></pre>
<br>
<h3>ğŸ¯ Responsabilidades por Proyecto</h3>
<br>
<h4>**Rokys.Audit.WebAPI**</h4>
<ul>
<li>Exponer API REST</li>
<li>AutenticaciÃ³n y autorizaciÃ³n</li>
<li>ValidaciÃ³n de entrada</li>
<li>Manejo de errores HTTP</li>
<li>DocumentaciÃ³n Swagger</li>
<li>Logging de requests</li>
</ul>
<br>
<h4>**Rokys.Audit.Services**</h4>
<ul>
<li>LÃ³gica de negocio</li>
<li>Validaciones de dominio</li>
<li>OrquestaciÃ³n de operaciones</li>
<li>GeneraciÃ³n de reportes</li>
<li>EnvÃ­o de emails</li>
<li>CÃ¡lculo de puntuaciones</li>
</ul>
<br>
<h4>**Rokys.Audit.Infrastructure.Persistence.EF**</h4>
<ul>
<li>Operaciones CRUD con EF Core</li>
<li>Transacciones de base de datos</li>
<li>Migraciones</li>
<li>Configuraciones de entidades</li>
</ul>
<br>
<h4>**Rokys.Audit.Infrastructure.Persistence.Dp**</h4>
<ul>
<li>Consultas optimizadas con Dapper</li>
<li>Reportes complejos</li>
<li>Operaciones de lectura masiva</li>
<li>Procedimientos almacenados</li>
</ul>
<br>
<h4>**Rokys.Audit.Subscription.Hub**</h4>
<ul>
<li>Escuchar eventos de RabbitMQ</li>
<li>Sincronizar datos de otros servicios</li>
<li>Procesar eventos de empleados</li>
<li>Mantener consistencia eventual</li>
</ul>
<br>
<hr>
<br>
<h2>Modelo de Datos</h2>
<br>
<h3>ğŸ—„ï¸ Esquema de Base de Datos</h3>
<br>
<p>Para la documentaciÃ³n completa del modelo de datos, consultar:</p>
<ul>
<li><a href="Rokys.Audit.DataBase/README.md">Diccionario de Datos</a></li>
<li><a href="Rokys.Audit.DataBase/Init/DataInitial.sql">Script de CreaciÃ³n</a></li>
</ul>
<br>
<h3>ğŸ“Š Diagrama ER Simplificado</h3>
<br>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Enterprise  â”‚â”€â”€1:Nâ”€â”€â”‚  Stores  â”‚â”€â”€1:Nâ”€â”€â”‚ PeriodAudit  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                          â”‚
      â”‚1:N                                       â”‚1:N
      â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Group    â”‚                       â”‚ PeriodAuditGroupResult â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                          â”‚
      â”‚1:N                                       â”‚1:N
      â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ScaleGroup  â”‚                       â”‚ PeriodAuditScaleResult â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                          â”‚
      â”‚1:N                                       â”‚1:N
      â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TableScaleTemplate   â”‚           â”‚ PeriodAuditTableScaleTemplate   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                                          â”‚
      â”‚1:N                                       â”‚1:N
      â–¼                                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AuditTemplateFields  â”‚           â”‚ PeriodAuditFieldValues   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
<br>
<h3>ğŸ”‘ Entidades Principales</h3>
<br>
<h4>**Enterprise** (Empresa)</h4>
<p>Representa la organizaciÃ³n o empresa que utiliza el sistema.</p>
<br>
<h4>**Stores** (Tiendas)</h4>
<p>Tiendas asociadas a una empresa donde se realizan las auditorÃ­as.</p>
<br>
<h4>**PeriodAudit** (AuditorÃ­a por PerÃ­odo)</h4>
<p>Encabezado de una auditorÃ­a realizada en una tienda durante un perÃ­odo especÃ­fico.</p>
<br>
<h4>**Group** (Grupo)</h4>
<p>AgrupaciÃ³n de criterios de auditorÃ­a (ej: Limpieza, Seguridad, Operaciones).</p>
<br>
<h4>**ScaleGroup** (Subgrupo de Escala)</h4>
<p>SubdivisiÃ³n de un grupo con criterios especÃ­ficos de evaluaciÃ³n.</p>
<br>
<h4>**TableScaleTemplate** (Plantilla de Tabla)</h4>
<p>Define la estructura de tablas de captura de datos (horizontal/vertical).</p>
<br>
<h4>**AuditTemplateFields** (Campos de Plantilla)</h4>
<p>Define los campos individuales dentro de una plantilla (texto, nÃºmero, fecha, etc.).</p>
<br>
<h4>**ScoringCriteria** (Criterios de PuntuaciÃ³n)</h4>
<p>Criterios de evaluaciÃ³n que determinan la puntuaciÃ³n final.</p>
<br>
<h4>**PeriodAuditFieldValues** (Valores Capturados)</h4>
<p>Valores reales capturados durante la ejecuciÃ³n de la auditorÃ­a.</p>
<br>
<hr>
<br>
<h2>Componentes Principales</h2>
<br>
<h3>ğŸ® Controllers (API Layer)</h3>
<br>
<h4>Estructura de Controllers</h4>
<br>
<p>Todos los controllers heredan de <code>ControllerBase</code> y estÃ¡n decorados con:</p>
<ul>
<li><code>[ApiController]</code></li>
<li><code>[Route("api/[controller]")]</code></li>
<li><code>[Authorize]</code> (cuando se requiere autenticaciÃ³n)</li>
</ul>
<br>
<h4>Controllers Principales</h4>
<br>
<table>
<thead><tr>
<th>Controller</th>
<th>Ruta Base</th>
<th>DescripciÃ³n</th>
</tr>
</thead><tbody>
<tr>
<td><strong>EnterpriseController</strong></td>
<td><code>/api/Enterprise</code></td>
<td>CRUD de empresas</td>
</tr>
<tr>
<td><strong>StoreController</strong></td>
<td><code>/api/Store</code></td>
<td>CRUD de tiendas</td>
</tr>
<tr>
<td><strong>PeriodAuditController</strong></td>
<td><code>/api/PeriodAudit</code></td>
<td>GestiÃ³n de auditorÃ­as</td>
</tr>
<tr>
<td><strong>GroupController</strong></td>
<td><code>/api/Group</code></td>
<td>CRUD de grupos</td>
</tr>
<tr>
<td><strong>ScaleGroupController</strong></td>
<td><code>/api/ScaleGroup</code></td>
<td>CRUD de subgrupos</td>
</tr>
<tr>
<td><strong>TableScaleTemplateController</strong></td>
<td><code>/api/TableScaleTemplate</code></td>
<td>GestiÃ³n de plantillas</td>
</tr>
<tr>
<td><strong>AuditTemplateFieldController</strong></td>
<td><code>/api/AuditTemplateField</code></td>
<td>Campos de plantillas</td>
</tr>
<tr>
<td><strong>ScoringCriteriaController</strong></td>
<td><code>/api/ScoringCriteria</code></td>
<td>Criterios de puntuaciÃ³n</td>
</tr>
<tr>
<td><strong>InboxItemsController</strong></td>
<td><code>/api/InboxItems</code></td>
<td>Bandeja de aprobaciones</td>
</tr>
<tr>
<td><strong>ReportsController</strong></td>
<td><code>/api/Reports</code></td>
<td>GeneraciÃ³n de reportes</td>
</tr>
<tr>
<td><strong>StorageFilesController</strong></td>
<td><code>/api/StorageFiles</code></td>
<td>GestiÃ³n de archivos</td>
</tr>
<tr>
<td><strong>UserReferenceController</strong></td>
<td><code>/api/UserReference</code></td>
<td>Usuarios sincronizados</td>
</tr>
</tbody></table>
<br>
<h3>ğŸ”§ Services (Business Logic Layer)</h3>
<br>
<h4>PatrÃ³n de Servicios</h4>
<br>
<p>Cada servicio sigue el patrÃ³n:</p>
<pre><code>public interface I[Entity]Service
{
    Task&lt;IEnumerable&lt;[Entity]&gt;&gt; GetAll();
    Task&lt;[Entity]&gt; GetById(Guid id);
    Task&lt;[Entity]&gt; Create([Entity]Dto dto);
    Task&lt;[Entity]&gt; Update(Guid id, [Entity]Dto dto);
    Task&lt;bool&gt; Delete(Guid id);
}

public class [Entity]Service : I[Entity]Service
{
    private readonly IRepository&lt;[Entity]&gt; _repository;
    private readonly IMapper _mapper;
    private readonly ILogger&lt;[Entity]Service&gt; _logger;

    // ImplementaciÃ³n...
}</code></pre>
<br>
<h4>Servicios Especializados</h4>
<br>
<p><strong>PeriodAuditService</strong></p>
<ul>
<li>CreaciÃ³n y gestiÃ³n de auditorÃ­as</li>
<li>CÃ¡lculo de puntuaciones</li>
<li>AplicaciÃ³n de criterios de evaluaciÃ³n</li>
<li>GeneraciÃ³n de resultados</li>
</ul>
<br>
<p><strong>ReportsService</strong></p>
<ul>
<li>GeneraciÃ³n de PDFs con QuestPDF</li>
<li>GeneraciÃ³n de Excel con ClosedXML</li>
<li>Consultas optimizadas para reportes</li>
</ul>
<br>
<p><strong>InboxItemsService</strong></p>
<ul>
<li>GestiÃ³n de flujo de aprobaciones</li>
<li>Transiciones de estado</li>
<li>Notificaciones de cambios</li>
</ul>
<br>
<p><strong>EmailService</strong> (External)</p>
<ul>
<li>EnvÃ­o de emails SMTP</li>
<li>Plantillas HTML con Scriban</li>
<li>Manejo de adjuntos</li>
</ul>
<br>
<h3>ğŸ—ƒï¸ Repositories (Data Access Layer)</h3>
<br>
<h4>PatrÃ³n Repository</h4>
<br>
<pre><code>public interface IRepository&lt;T&gt; where T : class
{
    Task&lt;IEnumerable&lt;T&gt;&gt; GetAll();
    Task&lt;T&gt; GetById(object id);
    Task&lt;T&gt; Add(T entity);
    Task&lt;T&gt; Update(T entity);
    Task&lt;bool&gt; Delete(object id);
}</code></pre>
<br>
<h4>Implementaciones</h4>
<br>
<p><strong>Entity Framework Repositories</strong></p>
<ul>
<li>Operaciones CRUD estÃ¡ndar</li>
<li>Soporte de transacciones</li>
<li>Tracking de cambios</li>
<li>NavegaciÃ³n de relaciones</li>
</ul>
<br>
<p><strong>Dapper Repositories</strong></p>
<ul>
<li>Consultas SQL raw optimizadas</li>
<li>Mapeo ligero</li>
<li>Rendimiento superior en lecturas</li>
<li>Consultas complejas con joins</li>
</ul>
<br>
<h3>ğŸ”„ AutoMapper Profiles</h3>
<br>
<p><strong>AMMapper.cs</strong> contiene los perfiles de mapeo:</p>
<br>
<pre><code>public class AMMapper : Profile
{
    public AMMapper()
    {
        CreateMap&lt;Enterprise, EnterpriseDto&gt;().ReverseMap();
        CreateMap&lt;Stores, StoreDto&gt;().ReverseMap();
        CreateMap&lt;PeriodAudit, PeriodAuditDto&gt;().ReverseMap();
        // ... mÃ¡s mapeos
    }
}</code></pre>
<br>
<h3>âœ… Validators (FluentValidation)</h3>
<br>
<p><strong>Ejemplo de Validator:</strong></p>
<br>
<pre><code>public class PeriodAuditValidator : AbstractValidator&lt;PeriodAuditDto&gt;
{
    public PeriodAuditValidator()
    {
        RuleFor(x =&gt; x.StoreId)
            .NotEmpty()
            .WithMessage("La tienda es requerida");

        RuleFor(x =&gt; x.StartDate)
            .LessThanOrEqualTo(x =&gt; x.EndDate)
            .WithMessage("La fecha de inicio debe ser menor a la fecha fin");

        RuleFor(x =&gt; x.ScoreValue)
            .GreaterThanOrEqualTo(0)
            .WithMessage("El puntaje no puede ser negativo");
    }
}</code></pre>
<br>
<hr>
<br>
<h2>API y Endpoints</h2>
<br>
<h3>ğŸ“¡ DocumentaciÃ³n de API</h3>
<br>
<p>La API estÃ¡ documentada con <strong>Swagger/OpenAPI</strong> y estÃ¡ disponible en:</p>
<ul>
<li><strong>Desarrollo</strong>: <code>http://localhost:5000/swagger</code></li>
<li><strong>QA</strong>: <code>http://172.16.10.12:8084/swagger</code></li>
</ul>
<br>
<h3>ğŸ” AutenticaciÃ³n</h3>
<br>
<p>Todos los endpoints (excepto <code>/api/Diagnostics</code>) requieren autenticaciÃ³n mediante <strong>JWT Bearer Token</strong>.</p>
<br>
<p><strong>Header requerido:</strong></p>
<pre><code>Authorization: Bearer &lt;token&gt;</code></pre>
<br>
<h3>ğŸ“ Endpoints Principales</h3>
<br>
<h4>**Enterprise** (Empresas)</h4>
<br>
<pre><code>GET    /api/Enterprise              # Listar todas las empresas
GET    /api/Enterprise/{id}         # Obtener empresa por ID
POST   /api/Enterprise              # Crear nueva empresa
PUT    /api/Enterprise/{id}         # Actualizar empresa
DELETE /api/Enterprise/{id}         # Eliminar empresa</code></pre>
<br>
<p><strong>Request Body (POST/PUT):</strong></p>
<pre><code>{
  "name": "Rokys S.A.",
  "code": "ROKYS01",
  "address": "Av. Principal 123",
  "isActive": true
}</code></pre>
<br>
<h4>**Stores** (Tiendas)</h4>
<br>
<pre><code>GET    /api/Store                   # Listar todas las tiendas
GET    /api/Store/{id}              # Obtener tienda por ID
GET    /api/Store/ByEnterprise/{id} # Tiendas por empresa
POST   /api/Store                   # Crear nueva tienda
PUT    /api/Store/{id}              # Actualizar tienda
DELETE /api/Store/{id}              # Eliminar tienda</code></pre>
<br>
<p><strong>Request Body (POST/PUT):</strong></p>
<pre><code>{
  "name": "Tienda San Miguel",
  "code": "TDA001",
  "address": "Av. La Marina 2000",
  "enterpriseId": "uuid-empresa",
  "isActive": true
}</code></pre>
<br>
<h4>**PeriodAudit** (AuditorÃ­as)</h4>
<br>
<pre><code>GET    /api/PeriodAudit                        # Listar auditorÃ­as
GET    /api/PeriodAudit/{id}                   # Obtener auditorÃ­a por ID
GET    /api/PeriodAudit/ByStore/{storeId}      # AuditorÃ­as por tienda
POST   /api/PeriodAudit                        # Crear nueva auditorÃ­a
PUT    /api/PeriodAudit/{id}                   # Actualizar auditorÃ­a
PUT    /api/PeriodAudit/{id}/Submit            # Enviar a aprobaciÃ³n
PUT    /api/PeriodAudit/{id}/Approve           # Aprobar auditorÃ­a
PUT    /api/PeriodAudit/{id}/Reject            # Rechazar auditorÃ­a
DELETE /api/PeriodAudit/{id}                   # Eliminar auditorÃ­a</code></pre>
<br>
<p><strong>Request Body (POST):</strong></p>
<pre><code>{
  "storeId": "uuid-tienda",
  "startDate": "2025-01-01",
  "endDate": "2025-01-31",
  "auditedDays": 31,
  "globalObservations": "AuditorÃ­a mensual enero",
  "participants": [
    {
      "userReferenceId": "uuid-usuario",
      "roleCode": "AUD",
      "roleName": "Auditor"
    }
  ]
}</code></pre>
<br>
<h4>**Reports** (Reportes)</h4>
<br>
<pre><code>GET    /api/Reports/Audit/{id}/Pdf              # Generar PDF de auditorÃ­a
GET    /api/Reports/Audit/{id}/Excel            # Generar Excel de auditorÃ­a
GET    /api/Reports/Store/{storeId}/Summary     # Resumen por tienda
GET    /api/Reports/Enterprise/{id}/Dashboard   # Dashboard empresarial</code></pre>
<br>
<p><strong>Respuesta:</strong></p>
<ul>
<li>PDF: <code>Content-Type: application/pdf</code></li>
<li>Excel: <code>Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet</code></li>
</ul>
<br>
<h4>**InboxItems** (Bandeja)</h4>
<br>
<pre><code>GET    /api/InboxItems/MyInbox                  # Mi bandeja de entrada
GET    /api/InboxItems/ByAudit/{auditId}        # Historial de una auditorÃ­a
POST   /api/InboxItems/Approve                  # Aprobar Ã­tem
POST   /api/InboxItems/Reject                   # Rechazar Ã­tem
POST   /api/InboxItems/Return                   # Devolver Ã­tem</code></pre>
<br>
<h4>**StorageFiles** (Archivos)</h4>
<br>
<pre><code>GET    /api/StorageFiles/{id}                   # Obtener archivo
GET    /api/StorageFiles/ByEntity/{entityId}    # Archivos por entidad
POST   /api/StorageFiles/Upload                 # Subir archivo
DELETE /api/StorageFiles/{id}                   # Eliminar archivo</code></pre>
<br>
<p><strong>Request (Upload):</strong></p>
<pre><code>POST /api/StorageFiles/Upload
Content-Type: multipart/form-data

--boundary
Content-Disposition: form-data; name="file"; filename="evidencia.pdf"
Content-Type: application/pdf

[binary data]
--boundary
Content-Disposition: form-data; name="entityId"

uuid-entidad
--boundary
Content-Disposition: form-data; name="entityName"

PeriodAudit
--boundary--</code></pre>
<br>
<h3>ğŸ“Š CÃ³digos de Respuesta HTTP</h3>
<br>
<table>
<thead><tr>
<th>CÃ³digo</th>
<th>DescripciÃ³n</th>
</tr>
</thead><tbody>
<tr>
<td>200 OK</td>
<td>OperaciÃ³n exitosa</td>
</tr>
<tr>
<td>201 Created</td>
<td>Recurso creado exitosamente</td>
</tr>
<tr>
<td>204 No Content</td>
<td>OperaciÃ³n exitosa sin contenido</td>
</tr>
<tr>
<td>400 Bad Request</td>
<td>Datos de entrada invÃ¡lidos</td>
</tr>
<tr>
<td>401 Unauthorized</td>
<td>No autenticado</td>
</tr>
<tr>
<td>403 Forbidden</td>
<td>No autorizado</td>
</tr>
<tr>
<td>404 Not Found</td>
<td>Recurso no encontrado</td>
</tr>
<tr>
<td>409 Conflict</td>
<td>Conflicto de negocio</td>
</tr>
<tr>
<td>500 Internal Server Error</td>
<td>Error del servidor</td>
</tr>
</tbody></table>
<br>
<h3>ğŸ“‹ Formato de Respuesta de Error</h3>
<br>
<pre><code>{
  "type": "https://tools.ietf.org/html/rfc7231#section-6.5.1",
  "title": "One or more validation errors occurred.",
  "status": 400,
  "errors": {
    "Name": ["El nombre es requerido"],
    "Code": ["El cÃ³digo ya existe"]
  },
  "traceId": "00-trace-id-00"
}</code></pre>
<br>
<hr>
<br>
<h2>Seguridad y AutenticaciÃ³n</h2>
<br>
<h3>ğŸ” Estrategia de Seguridad</h3>
<br>
<p>El sistema implementa mÃºltiples capas de seguridad:</p>
<br>
<li><strong>AutenticaciÃ³n JWT</strong></li>
<li><strong>AutorizaciÃ³n basada en roles</strong></li>
<li><strong>ValidaciÃ³n de tokens con IdentityServer</strong></li>
<li><strong>CORS configurado</strong></li>
<li><strong>HTTPS en producciÃ³n</strong></li>
<br>
<h3>ğŸ« AutenticaciÃ³n JWT</h3>
<br>
<p><strong>ConfiguraciÃ³n en appsettings.json:</strong></p>
<br>
<pre><code>{
  "JwtSettings": {
    "Issuer": "http://172.16.10.12:8082",
    "Audience": "rokys-audit-api",
    "Key": "9ba622c5-cb74-4c01-b33a-d24db6dcd1fc",
    "ExpirationInMinute": 10
  }
}</code></pre>
<br>
<p><strong>ConfiguraciÃ³n en Startup.cs:</strong></p>
<br>
<pre><code>services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =&gt;
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = jwtSettings.Issuer,
            ValidAudience = jwtSettings.Audience,
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes(jwtSettings.Key))
        };
    });</code></pre>
<br>
<h3>ğŸ›¡ï¸ IntegraciÃ³n con IdentityServer</h3>
<br>
<p><strong>ConfiguraciÃ³n:</strong></p>
<br>
<pre><code>{
  "IdentityServer": {
    "Authority": "http://172.16.10.12:8082/",
    "Audience": "rokys-audit-api",
    "ClientId": "rokys-audit-api",
    "ClientSecret": "rokys-audit-secret",
    "RequireHttpsMetadata": false
  }
}</code></pre>
<br>
<p><strong>Middleware de ValidaciÃ³n:</strong></p>
<br>
<pre><code>// CustomJwtValidationMiddleware.cs
public class CustomJwtValidationMiddleware
{
    public async Task InvokeAsync(HttpContext context)
    {
        var token = context.Request.Headers["Authorization"]
            .FirstOrDefault()?.Split(" ").Last();

        if (token != null)
        {
            await ValidateToken(token, context);
        }

        await _next(context);
    }
}</code></pre>
<br>
<h3>ğŸ‘¥ AutorizaciÃ³n basada en Roles</h3>
<br>
<p><strong>Roles del Sistema:</strong></p>
<br>
<table>
<thead><tr>
<th>CÃ³digo</th>
<th>Nombre</th>
<th>Permisos</th>
</tr>
</thead><tbody>
<tr>
<td><strong>ADM</strong></td>
<td>Administrador</td>
<td>Todos los permisos</td>
</tr>
<tr>
<td><strong>AUD</strong></td>
<td>Auditor</td>
<td>Crear y ejecutar auditorÃ­as</td>
</tr>
<tr>
<td><strong>SUP</strong></td>
<td>Supervisor</td>
<td>Aprobar/rechazar auditorÃ­as</td>
</tr>
<tr>
<td><strong>OPE</strong></td>
<td>Operaciones</td>
<td>Ver reportes</td>
</tr>
<tr>
<td><strong>GER</strong></td>
<td>Gerente</td>
<td>Dashboard ejecutivo</td>
</tr>
</tbody></table>
<br>
<p><strong>Uso en Controllers:</strong></p>
<br>
<pre><code>[Authorize(Roles = "ADM,SUP")]
[HttpPost("Approve/{id}")]
public async Task&lt;IActionResult&gt; ApproveAudit(Guid id)
{
    // Solo administradores y supervisores
}

[Authorize(Roles = "AUD")]
[HttpPost]
public async Task&lt;IActionResult&gt; CreateAudit([FromBody] PeriodAuditDto dto)
{
    // Solo auditores
}</code></pre>
<br>
<h3>ğŸŒ ConfiguraciÃ³n CORS</h3>
<br>
<pre><code>// Startup.cs
app.UseCors(x =&gt; x
    .WithOrigins(domains) // Configurado en appsettings
    .AllowAnyMethod()
    .AllowAnyHeader()
);</code></pre>
<br>
<p><strong>Dominios permitidos (appsettings.json):</strong></p>
<br>
<pre><code>{
  "AllowedHosts": "http://localhost:4200;http://172.16.10.12:8085"
}</code></pre>
<br>
<h3>ğŸ”’ Seguridad de Archivos</h3>
<br>
<p><strong>ValidaciÃ³n de archivos subidos:</strong></p>
<br>
<pre><code>{
  "FileSettings": {
    "MaxFileSize": 10485760,
    "AllowedFileTypes": [".pdf", ".xlsx", ".jpg", ".png", ".jpeg"],
    "Path": "D:\\AuditUploads"
  }
}</code></pre>
<br>
<p><strong>ValidaciÃ³n en cÃ³digo:</strong></p>
<br>
<pre><code>public async Task&lt;IActionResult&gt; Upload(IFormFile file)
{
    if (file.Length &gt; _fileSettings.MaxFileSize)
        return BadRequest("Archivo demasiado grande");

    var extension = Path.GetExtension(file.FileName);
    if (!_fileSettings.AllowedFileTypes.Contains(extension))
        return BadRequest("Tipo de archivo no permitido");

    // Procesar archivo...
}</code></pre>
<br>
<hr>
<br>
<h2>IntegraciÃ³n con Microservicios</h2>
<br>
<h3>ğŸ”— Arquitectura de Microservicios</h3>
<br>
<p>El Sistema de AuditorÃ­a forma parte de un ecosistema de microservicios:</p>
<br>
<pre><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Security MS     â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚   Audit MS       â”‚
â”‚  (Usuarios)      â”‚       â”‚  (Este sistema)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–²
                                    â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   RabbitMQ      â”‚
                           â”‚   Event Bus     â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Memos MS       â”‚â—€â”€â”€â”€â”€â”€â–¶â”‚   Other MS       â”‚
â”‚  (Empleados)     â”‚       â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
<br>
<h3>ğŸ° RabbitMQ Event Bus</h3>
<br>
<p><strong>ConfiguraciÃ³n:</strong></p>
<br>
<pre><code>{
  "RabbitMQ": {
    "HostName": "172.16.10.17",
    "Port": 5672,
    "UserName": "owner",
    "Password": "P4ss@78_#%a9",
    "EventsExchange": "rokys.events",
    "MicroserviceName": "audit",
    "ConnectionTimeout": 30000,
    "EnableRetries": true,
    "MaxRetries": 3
  }
}</code></pre>
<br>
<h3>ğŸ“¨ Eventos Publicados</h3>
<br>
<p>El sistema <strong>publica</strong> los siguientes eventos:</p>
<br>
<table>
<thead><tr>
<th>Evento</th>
<th>Routing Key</th>
<th>DescripciÃ³n</th>
</tr>
</thead><tbody>
<tr>
<td><strong>AuditCreatedEvent</strong></td>
<td><code>audit.created</code></td>
<td>Nueva auditorÃ­a creada</td>
</tr>
<tr>
<td><strong>AuditSubmittedEvent</strong></td>
<td><code>audit.submitted</code></td>
<td>AuditorÃ­a enviada a aprobaciÃ³n</td>
</tr>
<tr>
<td><strong>AuditApprovedEvent</strong></td>
<td><code>audit.approved</code></td>
<td>AuditorÃ­a aprobada</td>
</tr>
<tr>
<td><strong>AuditRejectedEvent</strong></td>
<td><code>audit.rejected</code></td>
<td>AuditorÃ­a rechazada</td>
</tr>
<tr>
<td><strong>AuditCompletedEvent</strong></td>
<td><code>audit.completed</code></td>
<td>AuditorÃ­a completada</td>
</tr>
</tbody></table>
<br>
<p><strong>Estructura de evento:</strong></p>
<br>
<pre><code>{
  "eventId": "uuid",
  "eventType": "AuditCreatedEvent",
  "timestamp": "2025-12-26T10:30:00Z",
  "source": "audit",
  "data": {
    "auditId": "uuid",
    "storeId": "uuid",
    "createdBy": "uuid",
    "status": "Draft"
  }
}</code></pre>
<br>
<h3>ğŸ“¬ Eventos Suscritos</h3>
<br>
<p>El sistema <strong>escucha</strong> los siguientes eventos:</p>
<br>
<table>
<thead><tr>
<th>Evento</th>
<th>Routing Key</th>
<th>AcciÃ³n</th>
</tr>
</thead><tbody>
<tr>
<td><strong>EmployeeCreatedEvent</strong></td>
<td><code>memos.employee.created</code></td>
<td>Crear UserReference</td>
</tr>
<tr>
<td><strong>EmployeeUpdatedEvent</strong></td>
<td><code>memos.employee.updated</code></td>
<td>Actualizar UserReference</td>
</tr>
<tr>
<td><strong>EmployeeDeletedEvent</strong></td>
<td><code>memos.employee.deleted</code></td>
<td>Desactivar UserReference</td>
</tr>
<tr>
<td><strong>UserCreatedEvent</strong></td>
<td><code>security.user.created</code></td>
<td>Sincronizar usuario</td>
</tr>
<tr>
<td><strong>UserUpdatedEvent</strong></td>
<td><code>security.user.updated</code></td>
<td>Actualizar usuario</td>
</tr>
</tbody></table>
<br>
<p><strong>ConfiguraciÃ³n de suscripciones:</strong></p>
<br>
<pre><code>{
  "RabbitMQ": {
    "Subscriptions": [
      {
        "RoutingKey": "memos.employee.created",
        "QueueName": "audit.employee_created_handler",
        "Description": "Audita cuando se crean empleados en Memos"
      },
      {
        "RoutingKey": "security.user.created",
        "QueueName": "audit.user_created_handler",
        "Description": "Audita cuando Security crea usuarios"
      }
    ]
  }
}</code></pre>
<br>
<h3>ğŸ”„ Subscription Hub</h3>
<br>
<p><strong>EmployeeEventService.cs</strong> maneja los eventos de empleados:</p>
<br>
<pre><code>public class EmployeeEventService : IEmployeeEventService
{
    private readonly IUserReferenceService _userReferenceService;
    private readonly ILogger&lt;EmployeeEventService&gt; _logger;

    public async Task HandleEmployeeCreated(EmployeeCreatedEvent evt)
    {
        _logger.LogInformation(
            "Processing EmployeeCreatedEvent for employee {EmployeeId}",
            evt.EmployeeId);

        var userRef = new UserReferenceDto
        {
            EmployeeId = evt.EmployeeId,
            FirstName = evt.FirstName,
            LastName = evt.LastName,
            Email = evt.Email,
            DocumentNumber = evt.DocumentNumber,
            IsActive = true
        };

        await _userReferenceService.Create(userRef);

        _logger.LogInformation(
            "UserReference created for employee {EmployeeId}",
            evt.EmployeeId);
    }
}</code></pre>
<br>
<h3>ğŸ”Œ IntegraciÃ³n con IdentityServer</h3>
<br>
<p><strong>IIdentityServerService.cs</strong> permite validar tokens y obtener informaciÃ³n de usuarios:</p>
<br>
<pre><code>public interface IIdentityServerService
{
    Task&lt;bool&gt; ValidateToken(string token);
    Task&lt;UserInfo&gt; GetUserInfo(string token);
    Task&lt;List&lt;string&gt;&gt; GetUserRoles(string userId);
}</code></pre>
<br>
<p><strong>Uso:</strong></p>
<br>
<pre><code>public class CustomJwtValidationMiddleware
{
    private readonly IIdentityServerService _identityServer;

    public async Task InvokeAsync(HttpContext context)
    {
        var token = GetTokenFromHeader(context);

        if (token != null)
        {
            var isValid = await _identityServer.ValidateToken(token);

            if (!isValid)
            {
                context.Response.StatusCode = 401;
                return;
            }

            var userInfo = await _identityServer.GetUserInfo(token);
            context.Items["UserInfo"] = userInfo;
        }

        await _next(context);
    }
}</code></pre>
<br>
<hr>
<br>
<h2>ConfiguraciÃ³n y Despliegue</h2>
<br>
<h3>âš™ï¸ ConfiguraciÃ³n de Ambientes</h3>
<br>
<p>El proyecto soporta mÃºltiples ambientes:</p>
<br>
<ul>
<li><strong>Development</strong> (appsettings.Development.json)</li>
<li><strong>Production</strong> (appsettings.Production.json)</li>
</ul>
<br>
<h3>ğŸ“ Variables de ConfiguraciÃ³n</h3>
<br>
<h4>**Cadenas de ConexiÃ³n**</h4>
<br>
<pre><code>{
  "ConnectionStrings": {
    "Main": "Server=172.16.10.12;Database=DBAuditQA;User=memo;Password=***;TrustServerCertificate=True;"
  }
}</code></pre>
<br>
<h4>**Seguridad**</h4>
<br>
<pre><code>{
  "Security": {
    "Enabled": true
  },
  "JwtSettings": {
    "Issuer": "http://172.16.10.12:8082",
    "Audience": "rokys-audit-api",
    "Key": "your-secret-key",
    "ExpirationInMinute": 10
  }
}</code></pre>
<br>
<h4>**Email**</h4>
<br>
<pre><code>{
  "Email": {
    "SmtpServer": "smtp.office365.com",
    "SmtpPort": 587,
    "Username": "trazabilidad.rrhh.gr@rokys.pe",
    "Password": "***",
    "FromName": "Notificacion Rokys",
    "FromEmail": "trazabilidad.rrhh.gr@rokys.pe"
  }
}</code></pre>
<br>
<h4>**Archivos**</h4>
<br>
<pre><code>{
  "FileSettings": {
    "MaxFileSize": 10485760,
    "AllowedFileTypes": [".pdf", ".xlsx", ".jpg", ".png", ".jpeg"],
    "Path": "D:\\AuditUploads"
  }
}</code></pre>
<br>
<h4>**RabbitMQ**</h4>
<br>
<pre><code>{
  "RabbitMQ": {
    "HostName": "172.16.10.17",
    "Port": 5672,
    "UserName": "owner",
    "Password": "***",
    "EventsExchange": "rokys.events",
    "MicroserviceName": "audit"
  }
}</code></pre>
<br>
<h3>ğŸš€ Despliegue</h3>
<br>
<h4>**Requisitos del Sistema**</h4>
<br>
<ul>
<li><strong>.NET 9.0 SDK</strong> o superior</li>
<li><strong>SQL Server 2019</strong> o superior</li>
<li><strong>RabbitMQ 3.x</strong> o superior</li>
<li><strong>Windows Server</strong> o <strong>Linux</strong></li>
<li><strong>IIS 10</strong> (Windows) o <strong>Nginx/Kestrel</strong> (Linux)</li>
</ul>
<br>
<h4>**Pasos de Despliegue**</h4>
<br>
<p><strong>1. Publicar la aplicaciÃ³n:</strong></p>
<br>
<pre><code>dotnet publish -c Release -o ./publish</code></pre>
<br>
<p><strong>2. Configurar Base de Datos:</strong></p>
<br>
<pre><code># Ejecutar scripts SQL
sqlcmd -S server -d DBAudit -i DataInitial.sql

# O usar Liquibase
liquibase --changeLogFile=changelog.xml update</code></pre>
<br>
<p><strong>3. Configurar IIS (Windows):</strong></p>
<br>
<ul>
<li>Crear Application Pool con .NET CLR: No Managed Code</li>
<li>Crear Website apuntando a la carpeta publish</li>
<li>Configurar bindings (puerto, SSL, etc.)</li>
<li>Asignar permisos a la carpeta de archivos</li>
</ul>
<br>
<p><strong>4. Configurar Kestrel (Linux):</strong></p>
<br>
<pre><code># Crear servicio systemd
sudo nano /etc/systemd/system/rokys-audit.service

[Unit]
Description=Rokys Audit API

[Service]
WorkingDirectory=/var/www/rokys-audit
ExecStart=/usr/bin/dotnet /var/www/rokys-audit/Rokys.Audit.WebAPI.dll
Restart=always
RestartSec=10
KillSignal=SIGINT
SyslogIdentifier=rokys-audit
User=www-data
Environment=ASPNETCORE_ENVIRONMENT=Production

[Install]
WantedBy=multi-user.target

# Habilitar e iniciar
sudo systemctl enable rokys-audit.service
sudo systemctl start rokys-audit.service</code></pre>
<br>
<p><strong>5. Configurar Nginx (Reverse Proxy):</strong></p>
<br>
<pre><code>server {
    listen 80;
    server_name audit.rokys.pe;

    location / {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection keep-alive;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}</code></pre>
<br>
<h3>ğŸ“¦ Docker (Opcional)</h3>
<br>
<p><strong>Dockerfile:</strong></p>
<br>
<pre><code>FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS base
WORKDIR /app
EXPOSE 80
EXPOSE 443

FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src
COPY ["Rokys.Audit.WebAPI/Rokys.Audit.WebAPI.csproj", "Rokys.Audit.WebAPI/"]
RUN dotnet restore "Rokys.Audit.WebAPI/Rokys.Audit.WebAPI.csproj"
COPY . .
WORKDIR "/src/Rokys.Audit.WebAPI"
RUN dotnet build "Rokys.Audit.WebAPI.csproj" -c Release -o /app/build

FROM build AS publish
RUN dotnet publish "Rokys.Audit.WebAPI.csproj" -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "Rokys.Audit.WebAPI.dll"]</code></pre>
<br>
<p><strong>docker-compose.yml:</strong></p>
<br>
<pre><code>version: '3.8'

services:
  audit-api:
    image: rokys-audit-api:latest
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8084:80"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ConnectionStrings__Main=Server=sql-server;Database=DBAudit;User=sa;Password=***
    depends_on:
      - sql-server
      - rabbitmq
    networks:
      - rokys-network

  sql-server:
    image: mcr.microsoft.com/mssql/server:2019-latest
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=YourStrong@Passw0rd
    ports:
      - "1433:1433"
    networks:
      - rokys-network

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - rokys-network

networks:
  rokys-network:
    driver: bridge</code></pre>
<br>
<h3>ğŸ” Monitoreo y Logging</h3>
<br>
<p><strong>Serilog</strong> estÃ¡ configurado para escribir logs en:</p>
<br>
<ul>
<li><strong>Consola</strong>: Desarrollo</li>
<li><strong>Archivo</strong>: <code>LogError/log-{Date}.txt</code></li>
<li><strong>SQL Server</strong>: (Opcional, configurar Serilog.Sinks.MSSqlServer)</li>
</ul>
<br>
<p><strong>ConfiguraciÃ³n de Serilog:</strong></p>
<br>
<pre><code>// Program.cs
Log.Logger = new LoggerConfiguration()
    .MinimumLevel.Information()
    .MinimumLevel.Override("Microsoft", LogEventLevel.Warning)
    .Enrich.FromLogContext()
    .WriteTo.Console()
    .WriteTo.File("LogError/log-.txt", rollingInterval: RollingInterval.Day)
    .CreateLogger();</code></pre>
<br>
<h3>ğŸ©º Health Checks</h3>
<br>
<p><strong>DiagnosticsController</strong> provee endpoints de diagnÃ³stico:</p>
<br>
<pre><code>GET /api/Diagnostics/Health        # Estado del servicio
GET /api/Diagnostics/Database      # Estado de la BD
GET /api/Diagnostics/RabbitMQ      # Estado de RabbitMQ
GET /api/Diagnostics/Version       # VersiÃ³n de la API</code></pre>
<br>
<hr>
<br>
<h2>GuÃ­as de Desarrollo</h2>
<br>
<h3>ğŸ› ï¸ ConfiguraciÃ³n del Entorno de Desarrollo</h3>
<br>
<h4>**Requisitos**</h4>
<br>
<ul>
<li><strong>Visual Studio 2022</strong> o <strong>Visual Studio Code</strong> con extensiÃ³n de C#</li>
<li><strong>.NET 9.0 SDK</strong></li>
<li><strong>SQL Server 2019</strong> o superior (o SQL Server Express)</li>
<li><strong>SQL Server Management Studio</strong> (SSMS)</li>
<li><strong>Git</strong></li>
<li><strong>Postman</strong> o similar (para pruebas de API)</li>
</ul>
<br>
<h4>**Clonar el Repositorio**</h4>
<br>
<pre><code>git clone https://github.com/RUWAYTECH/rokys-audit-service.git
cd rokys-audit-service</code></pre>
<br>
<h4>**Restaurar Paquetes NuGet**</h4>
<br>
<pre><code>dotnet restore</code></pre>
<br>
<h4>**Configurar Base de Datos Local**</h4>
<br>
<li>Crear base de datos:</li>
<pre><code>CREATE DATABASE DBAuditDev;</code></pre>
<br>
<li>Ejecutar script inicial:</li>
<pre><code>sqlcmd -S localhost -d DBAuditDev -i Rokys.Audit.DataBase/Init/DataInitial.sql</code></pre>
<br>
<li>Actualizar appsettings.Development.json:</li>
<pre><code>{
  "ConnectionStrings": {
    "Main": "Server=localhost;Database=DBAuditDev;Integrated Security=true;TrustServerCertificate=True;"
  }
}</code></pre>
<br>
<h4>**Ejecutar la AplicaciÃ³n**</h4>
<br>
<pre><code>cd Rokys.Audit.WebAPI
dotnet run</code></pre>
<br>
<p>La API estarÃ¡ disponible en:</p>
<ul>
<li>HTTP: <code>http://localhost:5000</code></li>
<li>HTTPS: <code>https://localhost:5001</code></li>
<li>Swagger: <code>http://localhost:5000/swagger</code></li>
</ul>
<br>
<h3>ğŸ“‹ EstÃ¡ndares de CÃ³digo</h3>
<br>
<h4>**Convenciones de Nombres**</h4>
<br>
<ul>
<li><strong>Clases</strong>: PascalCase (<code>PeriodAuditService</code>)</li>
<li><strong>MÃ©todos</strong>: PascalCase (<code>GetById</code>)</li>
<li><strong>Variables</strong>: camelCase (<code>userId</code>)</li>
<li><strong>Constantes</strong>: UPPER_SNAKE_CASE (<code>MAX_FILE_SIZE</code>)</li>
<li><strong>Interfaces</strong>: I + PascalCase (<code>IRepository</code>)</li>
</ul>
<br>
<h4>**Estructura de Archivos**</h4>
<br>
<ul>
<li>Un archivo por clase</li>
<li>Nombre del archivo = Nombre de la clase</li>
<li>Organizar por feature/dominio</li>
</ul>
<br>
<h4>**Comentarios**</h4>
<br>
<pre><code>/// &lt;summary&gt;
/// Obtiene una auditorÃ­a por su ID
/// &lt;/summary&gt;
/// &lt;param name="id"&gt;ID Ãºnico de la auditorÃ­a&lt;/param&gt;
/// &lt;returns&gt;Datos de la auditorÃ­a&lt;/returns&gt;
public async Task&lt;PeriodAudit&gt; GetById(Guid id)
{
    // ImplementaciÃ³n
}</code></pre>
<br>
<h3>ğŸ§ª Pruebas</h3>
<br>
<h4>**Estructura de Pruebas**</h4>
<br>
<pre><code>Rokys.Audit.Tests/
â”œâ”€â”€ Unit/
â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â””â”€â”€ PeriodAuditServiceTests.cs
â”‚   â””â”€â”€ Validators/
â”‚       â””â”€â”€ PeriodAuditValidatorTests.cs
â”œâ”€â”€ Integration/
â”‚   â”œâ”€â”€ Controllers/
â”‚   â”‚   â””â”€â”€ PeriodAuditControllerTests.cs
â”‚   â””â”€â”€ Repositories/
â”‚       â””â”€â”€ PeriodAuditRepositoryTests.cs
â””â”€â”€ E2E/
    â””â”€â”€ AuditWorkflowTests.cs</code></pre>
<br>
<h4>**Ejemplo de Prueba Unitaria**</h4>
<br>
<pre><code>[Fact]
public async Task GetById_WithValidId_ReturnsAudit()
{
    // Arrange
    var mockRepo = new Mock&lt;IRepository&lt;PeriodAudit&gt;&gt;();
    var audit = new PeriodAudit { PeriodAuditId = Guid.NewGuid() };
    mockRepo.Setup(r =&gt; r.GetById(It.IsAny&lt;Guid&gt;()))
            .ReturnsAsync(audit);

    var service = new PeriodAuditService(mockRepo.Object, null, null);

    // Act
    var result = await service.GetById(audit.PeriodAuditId);

    // Assert
    Assert.NotNull(result);
    Assert.Equal(audit.PeriodAuditId, result.PeriodAuditId);
}</code></pre>
<br>
<h3>ğŸ”„ Flujo de Trabajo con Git</h3>
<br>
<h4>**Branches**</h4>
<br>
<ul>
<li><code>main</code>: ProducciÃ³n</li>
<li><code>develop</code>: Desarrollo</li>
<li><code>feature/[nombre]</code>: Nueva funcionalidad</li>
<li><code>bugfix/[nombre]</code>: CorrecciÃ³n de bug</li>
<li><code>hotfix/[nombre]</code>: CorrecciÃ³n urgente en producciÃ³n</li>
</ul>
<br>
<h4>**Workflow**</h4>
<br>
<pre><code># Crear feature branch desde develop
git checkout develop
git pull origin develop
git checkout -b feature/nueva-funcionalidad

# Hacer commits
git add .
git commit -m "feat: agregar nueva funcionalidad"

# Push y crear Pull Request
git push origin feature/nueva-funcionalidad

# DespuÃ©s de revisiÃ³n, merge a develop
# Cuando estÃ© listo, merge a main para producciÃ³n</code></pre>
<br>
<h4>**Mensajes de Commit**</h4>
<br>
<p>Seguir convenciÃ³n <a href="https://www.conventionalcommits.org/">Conventional Commits</a>:</p>
<br>
<pre><code>feat: nueva funcionalidad
fix: correcciÃ³n de bug
docs: cambios en documentaciÃ³n
style: cambios de formato
refactor: refactorizaciÃ³n de cÃ³digo
test: agregar o modificar tests
chore: tareas de mantenimiento</code></pre>
<br>
<h3>ğŸ“ Proceso de Desarrollo de Features</h3>
<br>
<h4>**1. Crear Nueva Entidad**</h4>
<br>
<p><strong>Modelo (Tables/):</strong></p>
<pre><code>public class NewEntity : AuditEntity
{
    public Guid NewEntityId { get; set; }
    public string Name { get; set; }
    // ... otros campos
}</code></pre>
<br>
<p><strong>DTO (DTOs/):</strong></p>
<pre><code>public class NewEntityDto
{
    public Guid? NewEntityId { get; set; }
    public string Name { get; set; }
}</code></pre>
<br>
<p><strong>Validator (Validations/):</strong></p>
<pre><code>public class NewEntityValidator : AbstractValidator&lt;NewEntityDto&gt;
{
    public NewEntityValidator()
    {
        RuleFor(x =&gt; x.Name).NotEmpty();
    }
}</code></pre>
<br>
<h4>**2. Crear Servicios**</h4>
<br>
<p><strong>Interface (Services.Interfaces/):</strong></p>
<pre><code>public interface INewEntityService
{
    Task&lt;IEnumerable&lt;NewEntity&gt;&gt; GetAll();
    Task&lt;NewEntity&gt; GetById(Guid id);
    Task&lt;NewEntity&gt; Create(NewEntityDto dto);
    Task&lt;NewEntity&gt; Update(Guid id, NewEntityDto dto);
    Task&lt;bool&gt; Delete(Guid id);
}</code></pre>
<br>
<p><strong>ImplementaciÃ³n (Services/):</strong></p>
<pre><code>public class NewEntityService : INewEntityService
{
    private readonly IRepository&lt;NewEntity&gt; _repository;
    private readonly IMapper _mapper;

    public NewEntityService(
        IRepository&lt;NewEntity&gt; repository,
        IMapper mapper)
    {
        _repository = repository;
        _mapper = mapper;
    }

    // Implementar mÃ©todos...
}</code></pre>
<br>
<h4>**3. Crear Repository**</h4>
<br>
<p><strong>EF Core (Persistence.EF/):</strong></p>
<pre><code>public class NewEntityRepository : Repository&lt;NewEntity&gt;
{
    public NewEntityRepository(ApplicationDbContext context)
        : base(context)
    {
    }

    // MÃ©todos adicionales si es necesario
}</code></pre>
<br>
<h4>**4. Crear Controller**</h4>
<br>
<p><strong>Controller (WebAPI/Controllers/):</strong></p>
<pre><code>[ApiController]
[Route("api/[controller]")]
[Authorize]
public class NewEntityController : ControllerBase
{
    private readonly INewEntityService _service;

    public NewEntityController(INewEntityService service)
    {
        _service = service;
    }

    [HttpGet]
    public async Task&lt;IActionResult&gt; GetAll()
    {
        var items = await _service.GetAll();
        return Ok(items);
    }

    [HttpGet("{id}")]
    public async Task&lt;IActionResult&gt; GetById(Guid id)
    {
        var item = await _service.GetById(id);
        if (item == null) return NotFound();
        return Ok(item);
    }

    [HttpPost]
    public async Task&lt;IActionResult&gt; Create([FromBody] NewEntityDto dto)
    {
        var item = await _service.Create(dto);
        return CreatedAtAction(nameof(GetById),
            new { id = item.NewEntityId }, item);
    }

    [HttpPut("{id}")]
    public async Task&lt;IActionResult&gt; Update(
        Guid id, [FromBody] NewEntityDto dto)
    {
        var item = await _service.Update(id, dto);
        return Ok(item);
    }

    [HttpDelete("{id}")]
    public async Task&lt;IActionResult&gt; Delete(Guid id)
    {
        await _service.Delete(id);
        return NoContent();
    }
}</code></pre>
<br>
<h4>**5. Registrar en DI Container**</h4>
<br>
<p><strong>DependencyConfig.cs:</strong></p>
<pre><code>builder.RegisterType&lt;NewEntityService&gt;()
       .As&lt;INewEntityService&gt;()
       .InstancePerLifetimeScope();

builder.RegisterType&lt;NewEntityRepository&gt;()
       .As&lt;IRepository&lt;NewEntity&gt;&gt;()
       .InstancePerLifetimeScope();</code></pre>
<br>
<h4>**6. Agregar Mapper Profile**</h4>
<br>
<p><strong>AMMapper.cs:</strong></p>
<pre><code>CreateMap&lt;NewEntity, NewEntityDto&gt;().ReverseMap();</code></pre>
<br>
<h3>ğŸ› Debugging</h3>
<br>
<h4>**Visual Studio**</h4>
<br>
<li>Establecer breakpoints (F9)</li>
<li>Iniciar debug (F5)</li>
<li>Inspeccionar variables</li>
<li>Step Over (F10), Step Into (F11)</li>
<br>
<h4>**Logs**</h4>
<br>
<pre><code>_logger.LogInformation("Processing audit {AuditId}", auditId);
_logger.LogWarning("Store {StoreId} not found", storeId);
_logger.LogError(ex, "Error creating audit");</code></pre>
<br>
<h4>**SQL Profiler**</h4>
<br>
<p>Usar SQL Server Profiler para analizar queries de EF Core y Dapper.</p>
<br>
<h3>ğŸ“š Recursos Adicionales</h3>
<br>
<ul>
<li><a href="https://docs.microsoft.com/en-us/aspnet/core/">ASP.NET Core Documentation</a></li>
<li><a href="https://docs.microsoft.com/en-us/ef/core/">Entity Framework Core Documentation</a></li>
<li><a href="https://github.com/DapperLib/Dapper">Dapper Documentation</a></li>
<li><a href="https://docs.automapper.org/">AutoMapper Documentation</a></li>
<li><a href="https://docs.fluentvalidation.net/">FluentValidation Documentation</a></li>
<li><a href="https://www.rabbitmq.com/documentation.html">RabbitMQ Documentation</a></li>
</ul>
<br>
<hr>
<br>
<h2>ğŸ“ Contacto y Soporte</h2>
<br>
<p>Para soporte tÃ©cnico o preguntas sobre el proyecto:</p>
<br>
<ul>
<li><strong>Equipo</strong>: Ruwaytech Development Team</li>
<li><strong>Repositorio</strong>: https://github.com/RUWAYTECH/rokys-audit-service</li>
<li><strong>Branch Principal</strong>: <code>main</code></li>
<li><strong>Branch de Desarrollo</strong>: <code>develop</code></li>
</ul>
<br>
<hr>
<br>
<h2>ğŸ“„ Licencia</h2>
<br>
<p>Â© 2025 Ruwaytech. Todos los derechos reservados.</p>
<br>
<hr>
<br>
<p><strong>Ãšltima actualizaciÃ³n</strong>: Diciembre 26, 2025</p>
<p><strong>VersiÃ³n del documento</strong>: 1.0.0</p>
<p><strong>VersiÃ³n de la aplicaciÃ³n</strong>: 1.0.0</p>

</body>
</html>
